# ç›¸ä¼¼åº¦å¢å¼ºåŠŸèƒ½æµ‹è¯•æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ä½¿ç”¨ç°æœ‰checkpointè¿›è¡Œæ¨ç†æµ‹è¯•ï¼ˆæ¨èï¼Œæœ€å¿«ï¼‰

å¦‚æœå·²æœ‰è®­ç»ƒå¥½çš„SEMMA checkpointï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•å¢å¼ºç‰ˆæœ¬ï¼š

#### æ­¥éª¤1: ä¿®æ”¹flags.yamlå¯ç”¨EnhancedUltra

```bash
# ç¼–è¾‘flags.yaml
vim flags.yaml
# æˆ–è€…
nano flags.yaml
```

å°†ç¬¬ä¸€è¡Œæ”¹ä¸ºï¼š
```yaml
run: EnhancedUltra  # ä» semma æ”¹ä¸º EnhancedUltra
```

#### æ­¥éª¤2: è¿è¡Œæ¨ç†æµ‹è¯•

```bash
conda activate semma

# ä½¿ç”¨ç°æœ‰checkpointæµ‹è¯•ï¼ˆä¾‹å¦‚semma.pthï¼‰
python script/run.py \
    -c config/transductive/inference.yaml \
    --dataset FB15k237 \
    --epochs 0 \
    --bpe null \
    --ckpt ckpts/semma.pth \
    --gpus [0]
```

### æ–¹æ³•2: å®Œæ•´è®­ç»ƒ+è¯„ä¼°å¯¹æ¯”æµ‹è¯•

#### æ­¥éª¤1: æµ‹è¯•åŸºçº¿SEMMAï¼ˆæ— å¢å¼ºï¼‰

```bash
# 1. è®¾ç½®flags.yamlä¸ºåŸºçº¿
# flags.yamlä¸­è®¾ç½®: run: semma

# 2. è®­ç»ƒï¼ˆå¦‚æœéœ€è¦é‡æ–°è®­ç»ƒï¼‰
python script/pretrain.py \
    -c config/transductive/pretrain_3g.yaml \
    --gpus [0]

# 3. è¯„ä¼°åŸºçº¿æ€§èƒ½
python script/run.py \
    -c config/transductive/inference.yaml \
    --dataset FB15k237 \
    --epochs 0 \
    --bpe null \
    --ckpt ckpts/semma.pth \
    --gpus [0]
    
# è®°å½•ç»“æœåˆ° baseline_results.log
python script/run.py ... > baseline_results.log 2>&1
```

#### æ­¥éª¤2: æµ‹è¯•EnhancedUltraï¼ˆæœ‰å¢å¼ºï¼‰

```bash
# 1. ä¿®æ”¹flags.yaml
# flags.yamlä¸­è®¾ç½®: run: EnhancedUltra

# 2. ä½¿ç”¨ç›¸åŒçš„checkpointè¿›è¡Œæµ‹è¯•ï¼ˆæˆ–é‡æ–°è®­ç»ƒï¼‰
python script/run.py \
    -c config/transductive/inference.yaml \
    --dataset FB15k237 \
    --epochs 0 \
    --bpe null \
    --ckpt ckpts/semma.pth \
    --gpus [0]

# è®°å½•ç»“æœåˆ° enhanced_results.log
python script/run.py ... > enhanced_results.log 2>&1
```

#### æ­¥éª¤3: å¯¹æ¯”ç»“æœ

```bash
# æå–å…³é”®æŒ‡æ ‡
echo "=== åŸºçº¿æ€§èƒ½ ==="
grep -E "(mrr|hits@)" baseline_results.log

echo "=== å¢å¼ºæ€§èƒ½ ==="
grep -E "(mrr|hits@)" enhanced_results.log
```

## ğŸ“‹ è¯¦ç»†æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯1: å¿«é€ŸéªŒè¯ï¼ˆä½¿ç”¨ç°æœ‰checkpointï¼‰

**ç›®æ ‡**: å¿«é€ŸéªŒè¯å¢å¼ºåŠŸèƒ½æ˜¯å¦å·¥ä½œ

```bash
# 1. å¤‡ä»½flags.yaml
cp flags.yaml flags.yaml.backup

# 2. ä¿®æ”¹flags.yamlå¯ç”¨EnhancedUltra
sed -i 's/run: semma/run: EnhancedUltra/' flags.yaml

# 3. è¿è¡Œæµ‹è¯•
conda activate semma
python script/run.py \
    -c config/transductive/inference.yaml \
    --dataset FB15k237 \
    --epochs 0 \
    --bpe null \
    --ckpt ckpts/semma.pth \
    --gpus [0]

# 4. æŸ¥çœ‹ç»“æœ
# æ£€æŸ¥æ—¥å¿—ä¸­çš„ MRR, Hits@1, Hits@10 ç­‰æŒ‡æ ‡

# 5. æ¢å¤flags.yamlï¼ˆå¦‚æœéœ€è¦ï¼‰
mv flags.yaml.backup flags.yaml
```

### æµ‹è¯•åœºæ™¯2: å®Œæ•´å¯¹æ¯”æµ‹è¯•

**ç›®æ ‡**: å¯¹æ¯”åŸºçº¿å’Œå¢å¼ºç‰ˆæœ¬çš„æ€§èƒ½å·®å¼‚

```bash
# ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼ˆè§ä¸‹é¢ï¼‰
bash test_similarity_enhancement.sh
```

### æµ‹è¯•åœºæ™¯3: ä¸åŒæ•°æ®é›†æµ‹è¯•

**æ”¯æŒçš„æ•°æ®é›†**:
- FB15k237
- WN18RR
- CoDExSmall
- CoDExMedium
- CoDExLarge
- ç­‰ç­‰

```bash
# æµ‹è¯•ä¸åŒæ•°æ®é›†
for dataset in FB15k237 WN18RR CoDExSmall; do
    echo "Testing $dataset..."
    
    # åŸºçº¿
    python script/run.py \
        -c config/transductive/inference.yaml \
        --dataset $dataset \
        --epochs 0 --bpe null \
        --ckpt ckpts/semma.pth \
        --gpus [0] \
        > results_baseline_${dataset}.log 2>&1
    
    # ä¿®æ”¹flags.yamlä¸ºEnhancedUltra
    sed -i 's/run: semma/run: EnhancedUltra/' flags.yaml
    
    # å¢å¼ºç‰ˆ
    python script/run.py \
        -c config/transductive/inference.yaml \
        --dataset $dataset \
        --epochs 0 --bpe null \
        --ckpt ckpts/semma.pth \
        --gpus [0] \
        > results_enhanced_${dataset}.log 2>&1
    
    # æ¢å¤flags.yaml
    sed -i 's/run: EnhancedUltra/run: semma/' flags.yaml
done
```

## ğŸ”§ å‚æ•°è°ƒæ•´ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³è°ƒæ•´å¢å¼ºå‚æ•°ï¼Œå¯ä»¥ç¼–è¾‘ `ultra/enhanced_models.py`:

```python
# ç¬¬299-302è¡Œ
self.similarity_enhancer = SimilarityBasedRelationEnhancer(
    embedding_dim=64,
    similarity_threshold_init=0.5,  # è°ƒæ•´åˆå§‹é˜ˆå€¼ (0.3-0.7)
    enhancement_strength_init=0.05   # è°ƒæ•´åˆå§‹å¼ºåº¦ (0.03-0.10)
)
```

## ğŸ“Š å¦‚ä½•æŸ¥çœ‹ç»“æœ

### å…³é”®æŒ‡æ ‡

åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾ä»¥ä¸‹æŒ‡æ ‡ï¼š
- **MRR**: Mean Reciprocal Rankï¼ˆå¹³å‡å€’æ•°æ’åï¼‰
- **Hits@1**: Top-1å‡†ç¡®ç‡
- **Hits@3**: Top-3å‡†ç¡®ç‡
- **Hits@10**: Top-10å‡†ç¡®ç‡
- **MR**: Mean Rankï¼ˆå¹³å‡æ’åï¼Œè¶Šå°è¶Šå¥½ï¼‰

### ç¤ºä¾‹æ—¥å¿—è¾“å‡º

```
16:24:06   mr: 693.988
16:24:06   mrr: 0.545501
16:24:06   hits@1: 0.491385
16:24:06   hits@3: 0.568124
16:24:06   hits@10: 0.654914
```

### å¯¹æ¯”åˆ†æ

è®¡ç®—æå‡ç™¾åˆ†æ¯”ï¼š
```
MRRæå‡ = (enhanced_mrr - baseline_mrr) / baseline_mrr * 100%
```

ä¾‹å¦‚ï¼š
- åŸºçº¿ MRR: 0.545
- å¢å¼º MRR: 0.550
- æå‡: (0.550 - 0.545) / 0.545 * 100% = +0.92%

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Checkpointå…¼å®¹æ€§**: 
   - EnhancedUltraå¯ä»¥åŠ è½½SEMMAçš„checkpoint
   - æ–°å¢çš„ç›¸ä¼¼åº¦å¢å¼ºæ¨¡å—å‚æ•°ä¼šéšæœºåˆå§‹åŒ–
   - å¦‚æœæƒ³è®­ç»ƒå¢å¼ºå‚æ•°ï¼Œéœ€è¦ç»§ç»­è®­ç»ƒ

2. **è®­ç»ƒvsæ¨ç†**:
   - å½“å‰å®ç°ï¼šè®­ç»ƒå’Œæ¨ç†éƒ½å¼€å¯å¢å¼º
   - å¢å¼ºå‚æ•°ä¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ ä¼˜åŒ–

3. **å†…å­˜ä½¿ç”¨**:
   - ç›¸ä¼¼åº¦è®¡ç®—ä¼šå¢åŠ ä¸€äº›å†…å­˜å¼€é”€
   - å¯¹äºå¤§æ‰¹æ¬¡æˆ–å¤§é‡å…³ç³»ï¼Œæ³¨æ„GPUå†…å­˜

4. **æ€§èƒ½å½±å“**:
   - æ¯ä¸ªbatchéœ€è¦è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ
   - æ¨ç†é€Ÿåº¦å¯èƒ½ç•¥å¾®ä¸‹é™ï¼ˆé€šå¸¸<5%ï¼‰

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: æ‰¾ä¸åˆ°EnhancedUltraæ¨¡å—

**é”™è¯¯**: `NameError: name 'EnhancedUltra' is not defined`

**è§£å†³**: 
```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /T20030104/ynj/semma

# æ£€æŸ¥å¯¼å…¥
python -c "from ultra.enhanced_models import EnhancedUltra; print('OK')"
```

### é—®é¢˜2: CheckpointåŠ è½½å¤±è´¥

**é”™è¯¯**: `RuntimeError: Unexpected key(s) in state_dict`

**è§£å†³**: ä»£ç ä¸­å·²æœ‰å¤„ç†ï¼Œä¼šè‡ªåŠ¨è¿‡æ»¤ä¸åŒ¹é…çš„é”®ã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯èƒ½æ˜¯checkpointç‰ˆæœ¬ä¸åŒ¹é…ã€‚

### é—®é¢˜3: æ€§èƒ½ä¸‹é™

**å¯èƒ½åŸå› **:
- å¢å¼ºå¼ºåº¦è¿‡å¤§ â†’ å‡å° `enhancement_strength_init`
- é˜ˆå€¼ä¸åˆé€‚ â†’ è°ƒæ•´ `similarity_threshold_init`
- æ•°æ®é›†å…³ç³»å·®å¼‚æ€§å¤§ â†’ å¯èƒ½ä¸é€‚ç”¨

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] ä¿®æ”¹flags.yaml: `run: EnhancedUltra`
- [ ] å‡†å¤‡checkpointæ–‡ä»¶ï¼ˆå¦‚ï¼šckpts/semma.pthï¼‰
- [ ] è¿è¡Œæ¨ç†æµ‹è¯•
- [ ] è®°å½•MRRã€Hits@1ã€Hits@10ç­‰æŒ‡æ ‡
- [ ] å¯¹æ¯”åŸºçº¿æ€§èƒ½ï¼ˆå¯é€‰ï¼‰
- [ ] åˆ†æç»“æœï¼Œè®¡ç®—æå‡ç™¾åˆ†æ¯”

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å¿«é€ŸéªŒè¯**: ä½¿ç”¨ç°æœ‰checkpointå¿«é€Ÿæµ‹è¯•
2. **å®Œæ•´å¯¹æ¯”**: è¿è¡ŒåŸºçº¿å’Œå¢å¼ºç‰ˆæœ¬çš„å¯¹æ¯”æµ‹è¯•
3. **å‚æ•°è°ƒä¼˜**: å¦‚æœæ•ˆæœä¸æ˜æ˜¾ï¼Œå°è¯•è°ƒæ•´åˆå§‹å‚æ•°
4. **è¯¦ç»†åˆ†æ**: åˆ†æå“ªäº›ç±»å‹çš„å…³ç³»å—ç›Šæœ€å¤š


