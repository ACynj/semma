# 问题诊断报告：1跳邻居导致性能严重下降

## 问题描述

在另一个服务器上，固定了1跳邻居（`max_hops=1`），其余配置与当前服务器完全一样，但第一轮验证集结果非常差：

### 另一个服务器（max_hops=1）的结果：
- **第一轮**: MRR=0.0106, hits@1=0.001, hits@10=0.021
- **第二轮**: MRR=0.1157, hits@1=0.072, hits@10=0.187  
- **第三轮**: MRR=0.0335, hits@1=0.019, hits@10=0.05

### 当前服务器（max_hops=2）的配置：
- `max_hops: 2` （flags.yaml第27行）

## 根本原因分析

### 1. 提示图信息不足

当 `max_hops=1` 时，`_get_k_hop_neighbors` 函数只会获取查询实体的**直接邻居**（1跳）。这导致：

```python
# 在 generate_prompt_graph 函数中（第969行）
prompt_entities = self._get_k_hop_neighbors(data, seed_entities, max_hops=self.max_hops)
```

- **1跳邻居**：只包括查询实体本身 + 直接连接的实体
- **2跳邻居**：包括查询实体 + 1跳邻居 + 2跳邻居（邻居的邻居）

### 2. 代码逻辑分析

在 `ultra/enhanced_models.py` 的 `_get_k_hop_neighbors` 函数中：

```259:270:ultra/enhanced_models.py
        # BFS遍历k跳
        for hop in range(max_hops):
            next_frontier = set()
            for entity in current_frontier:
                if entity in adj_list:
                    neighbors = adj_list[entity]
                    for neighbor in neighbors:
                        if neighbor not in relevant_entities:
                            relevant_entities.add(neighbor)
                            next_frontier.add(neighbor)
            current_frontier = next_frontier
            if not current_frontier:  # 如果没有新邻居，提前结束
                break
```

**关键问题**：
- `range(1)` 只执行1次循环 → 只获取1跳邻居
- `range(2)` 执行2次循环 → 获取1跳 + 2跳邻居

### 3. 性能影响

1. **提示图太小**：1跳邻居可能只有很少的实体（特别是稀疏图）
2. **上下文信息不足**：Prompt Enhancer无法从如此小的子图中学习到足够的上下文
3. **关系增强受限**：相似度增强器可能也无法充分利用有限的邻居信息
4. **训练不稳定**：从结果波动可以看出（MRR从0.01→0.11→0.03），模型训练不稳定

## 解决方案

### 方案1：修改 max_hops 配置（推荐）

在另一个服务器的 `flags.yaml` 中，将 `max_hops` 从 1 改为 2：

```yaml
max_hops: 2  # 最大跳数：使用2跳邻居（从1改为2）
```

### 方案2：检查其他可能的问题

如果修改跳数后仍然效果差，需要检查：

1. **数据集是否一致**：确保两个服务器使用相同的数据集
2. **随机种子**：确保随机种子相同
3. **模型初始化**：确保使用相同的预训练模型或检查点
4. **GPU环境**：检查CUDA版本、PyTorch版本是否一致
5. **其他配置参数**：检查 `num_prompt_samples`、`max_similar_relations` 等参数是否一致

### 方案3：添加诊断日志

在 `generate_prompt_graph` 函数中添加日志，查看提示图的大小：

```python
logger.info(f"[Prompt Graph] max_hops={self.max_hops}, prompt_entities数量={len(prompt_entities_list)}")
```

## 建议

**不建议继续用 max_hops=1 训练**，因为：

1. **性能太差**：MRR=0.01 几乎等于随机猜测
2. **不稳定**：结果波动大，说明模型无法有效学习
3. **信息不足**：1跳邻居提供的上下文信息太少，无法支持有效的增强

**建议立即修改为 max_hops=2**，然后重新训练。如果资源允许，甚至可以尝试 max_hops=3，但要注意内存消耗。

## 验证步骤

修改配置后，建议：

1. 检查日志中是否有 "BFS遍历2跳" 的输出
2. 观察第一轮验证结果是否显著提升（应该MRR > 0.1）
3. 监控训练过程中的性能指标是否稳定上升

