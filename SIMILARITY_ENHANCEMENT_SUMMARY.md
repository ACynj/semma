# åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„å…³ç³»å¢å¼ºå®ç°æ€»ç»“

## âœ… å®ç°å®Œæˆ

å·²åœ¨ EnhancedUltra æ¨¡å‹åŸºç¡€ä¸ŠæˆåŠŸå®ç°äº†åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„å…³ç³»å¢å¼ºæ¨¡å—ã€‚

## ğŸ“‹ å®ç°å†…å®¹

### 1. æ ¸å¿ƒæ¨¡å—ï¼š`SimilarityBasedRelationEnhancer`

- **ä½ç½®**: `ultra/enhanced_models.py`
- **åŠŸèƒ½**: æ ¹æ®æŸ¥è¯¢å…³ç³»ä¸æ‰€æœ‰å…³ç³»çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ™ºèƒ½å‚è€ƒç›¸ä¼¼å…³ç³»æ¥å¢å¼ºæŸ¥è¯¢å…³ç³»è¡¨ç¤º

### 2. æ ¸å¿ƒç‰¹æ€§

âœ… **ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—**: å¯¹æ¯ä¸ªæŸ¥è¯¢å…³ç³»è®¡ç®—ä¸æ‰€æœ‰å…³ç³»çš„ä½™å¼¦ç›¸ä¼¼åº¦  
âœ… **å¯å­¦ä¹ é˜ˆå€¼**: ä½¿ç”¨sigmoidå¹³æ»‘é˜ˆå€¼è¿‡æ»¤ï¼Œå…è®¸é˜ˆå€¼å‚ä¸æ¢¯åº¦è®¡ç®—  
âœ… **ç›¸ä¼¼åº¦åŠ æƒ**: ç›¸ä¼¼åº¦è¶Šé«˜ï¼Œå‚è€ƒæƒé‡è¶Šå¤§  
âœ… **å¯å­¦ä¹ å¢å¼ºå¼ºåº¦**: é»˜è®¤0.05ï¼Œä¿æŒè¾ƒå°ä»¥é¿å…è¿‡åº¦å½±å“åŸæ¨¡å‹  
âœ… **å¯å­¦ä¹ å‚æ•°**: åŒ…å«4ä¸ªå¯å­¦ä¹ å‚æ•°ï¼Œæ¨¡å‹å¯è‡ªé€‚åº”è°ƒæ•´ç­–ç•¥  

### 3. å¯å­¦ä¹ å‚æ•°

| å‚æ•° | åˆå§‹å€¼ | èŒƒå›´ | ä½œç”¨ |
|------|--------|------|------|
| `similarity_threshold_raw` | 0.5 | [0, 1] | ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆç»è¿‡sigmoidæ˜ å°„ï¼‰ |
| `enhancement_strength_raw` | 0.05 | [0, 0.2] | å¢å¼ºå¼ºåº¦ï¼ˆç»è¿‡sigmoidæ˜ å°„ï¼‰ |
| `similarity_weight_scale` | 1.0 | ä»»æ„ | ç›¸ä¼¼åº¦æƒé‡ç¼©æ”¾å› å­ |
| `temperature` | 1.0 | [0.1, 10.0] | Softmaxæ¸©åº¦å‚æ•° |

### 4. å·¥ä½œæµç¨‹

```
1. è·å–æŸ¥è¯¢å…³ç³»è¡¨ç¤º â†’ final_relation_representations[batch_idx, query_rel_idx, :]
2. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ â†’ ä¸æ‰€æœ‰å…³ç³»è®¡ç®—ç›¸ä¼¼åº¦
3. å¹³æ»‘é˜ˆå€¼è¿‡æ»¤ â†’ ä½¿ç”¨sigmoidå®ç°å¯å¾®åˆ†çš„é˜ˆå€¼è¿‡æ»¤
4. ç›¸ä¼¼åº¦åŠ æƒ â†’ ä½¿ç”¨softmaxå’Œå¯å­¦ä¹ ç¼©æ”¾å› å­è®¡ç®—æƒé‡
5. åŠ æƒèåˆ â†’ è®¡ç®—åŠ æƒå¹³å‡çš„ç›¸ä¼¼å…³ç³»è¡¨ç¤º
6. åº”ç”¨å¢å¼º â†’ enhanced = (1-Î±)*original + Î±*weighted_similar
```

## ğŸ§ª æµ‹è¯•ç»“æœ

æµ‹è¯•è„šæœ¬: `test_similarity_enhancer.py`

âœ… **å½¢çŠ¶éªŒè¯**: è¾“å‡ºå½¢çŠ¶æ­£ç¡® `[batch_size, num_relations, embedding_dim]`  
âœ… **å¢å¼ºæ•ˆæœ**: æ‰¾åˆ°ç›¸ä¼¼å…³ç³»æ—¶ï¼Œå¢å¼ºç”Ÿæ•ˆï¼Œè¡¨ç¤ºæœ‰å˜åŒ–  
âœ… **é˜ˆå€¼è¿‡æ»¤**: ç›¸ä¼¼åº¦ä½äºé˜ˆå€¼æ—¶ï¼Œä¿æŒåŸæ ·  
âœ… **æ¢¯åº¦è®¡ç®—**: æ‰€æœ‰4ä¸ªå¯å­¦ä¹ å‚æ•°éƒ½æœ‰æ¢¯åº¦ï¼Œå¯ä»¥æ­£å¸¸è®­ç»ƒ  

æµ‹è¯•è¾“å‡ºç¤ºä¾‹ï¼š
```
æŸ¥è¯¢å…³ç³» 0 (batch 0):
  æœ€å¤§ç›¸ä¼¼åº¦: 0.9934 (é˜ˆå€¼: 0.5000)
  âœ… æ‰¾åˆ°ç›¸ä¼¼å…³ç³»ï¼Œå¢å¼ºç”Ÿæ•ˆ
  å·®å¼‚: 0.078148

æŸ¥è¯¢å…³ç³» 2 (batch 2):
  æœ€å¤§ç›¸ä¼¼åº¦: 0.1214 (é˜ˆå€¼: 0.5000)
  â„¹ï¸  æœªæ‰¾åˆ°ç›¸ä¼¼å…³ç³»ï¼ˆç›¸ä¼¼åº¦ä½äºé˜ˆå€¼ï¼‰ï¼Œä¿æŒåŸæ ·
  å·®å¼‚: 0.000000

âœ… æ‰€æœ‰å¯å­¦ä¹ å‚æ•°éƒ½æœ‰æ¢¯åº¦ï¼Œå¯ä»¥æ­£å¸¸è®­ç»ƒ
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. é…ç½® flags.yaml

ç¡®ä¿ `run` è®¾ç½®ä¸º `EnhancedUltra`:

```yaml
run: EnhancedUltra
```

### 2. è®­ç»ƒæ¨¡å‹

```bash
conda activate semma
python script/pretrain.py -c config/transductive/pretrain_3g.yaml --gpus [0]
```

### 3. è¯„ä¼°æ¨¡å‹

```bash
python script/run.py -c config/transductive/run_3g.yaml --gpus [0]
```

## ğŸ’¡ è®¾è®¡æ€è·¯

### ä¿å®ˆå¢å¼ºç­–ç•¥

- **å°å¼ºåº¦å¢å¼º**: é»˜è®¤å¢å¼ºå¼ºåº¦ä»…0.05ï¼Œç¡®ä¿ä¸ä¼šæ˜¾è‘—æ”¹å˜SEMMAæ¨¡å‹çš„æ€§èƒ½
- **ç›¸ä¼¼åº¦é©±åŠ¨**: åªå‚è€ƒçœŸæ­£ç›¸ä¼¼çš„å…³ç³»ï¼ˆç›¸ä¼¼åº¦>é˜ˆå€¼ï¼‰ï¼Œé¿å…å¼•å…¥å™ªå£°
- **å¹³æ»‘é˜ˆå€¼**: ä½¿ç”¨sigmoidå®ç°å¯å¾®åˆ†çš„é˜ˆå€¼è¿‡æ»¤ï¼Œå…è®¸é˜ˆå€¼å‚ä¸è®­ç»ƒ

### è‡ªé€‚åº”å­¦ä¹ 

- **å¯å­¦ä¹ é˜ˆå€¼**: æ¨¡å‹å¯ä»¥è‡ªåŠ¨å­¦ä¹ æœ€ä½³ç›¸ä¼¼åº¦é˜ˆå€¼
- **å¯å­¦ä¹ å¼ºåº¦**: æ¨¡å‹å¯ä»¥è‡ªåŠ¨è°ƒæ•´å¢å¼ºå¼ºåº¦
- **å¯å­¦ä¹ æƒé‡**: æ¨¡å‹å¯ä»¥è‡ªåŠ¨è°ƒæ•´ç›¸ä¼¼åº¦å¯¹æƒé‡çš„å½±å“

### æœ€å°åŒ–å½±å“

- **è®­ç»ƒå’Œæ¨ç†ä¸€è‡´**: åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½ä½¿ç”¨å¢å¼ºï¼Œä½†å¼ºåº¦è¾ƒå°
- **ä¿æŒåŸè¡¨ç¤º**: å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸ä¼¼å…³ç³»ï¼Œå®Œå…¨ä¿æŒåŸè¡¨ç¤ºä¸å˜
- **çº¿æ€§æ’å€¼**: ä½¿ç”¨ç®€å•çš„çº¿æ€§æ’å€¼ï¼Œç¡®ä¿å¢å¼ºæ˜¯å¯é¢„æµ‹çš„

## ğŸ“Š é¢„æœŸæ•ˆæœ

1. **ä¿æŒSEMMAæ€§èƒ½**: ç”±äºå¢å¼ºå¼ºåº¦å¾ˆå°ï¼ŒåŸæ¨¡å‹æ€§èƒ½ä¸åº”ä¸‹é™
2. **å°å¹…æå‡**: é€šè¿‡å‚è€ƒç›¸ä¼¼å…³ç³»ï¼Œå¯èƒ½åœ¨éƒ¨åˆ†æŸ¥è¯¢ä¸Šè·å¾—å°å¹…æå‡
3. **æ›´å¥½çš„æ³›åŒ–**: å¯¹äºç›¸ä¼¼å…³ç³»çš„æŸ¥è¯¢ï¼Œèƒ½å¤Ÿåˆ©ç”¨ç›¸å…³å…³ç³»çš„çŸ¥è¯†

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—

```python
# å½’ä¸€åŒ–
query_norm = F.normalize(query_rel_repr, p=2, dim=0)
all_norms = F.normalize(all_rel_reprs, p=2, dim=1)

# è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
similarities = torch.matmul(query_norm.unsqueeze(0), all_norms.t()).squeeze(0)
```

### å¹³æ»‘é˜ˆå€¼è¿‡æ»¤

```python
# ä½¿ç”¨sigmoidå®ç°å¹³æ»‘é˜ˆå€¼ï¼Œä¿ç•™æ¢¯åº¦
similarity_weights = torch.sigmoid((similarities - threshold) * 10.0)
above_threshold = similarity_weights > 0.5
```

### åŠ æƒèåˆ

```python
# Softmaxæƒé‡ï¼ˆåŸºäºç›¸ä¼¼åº¦ï¼‰
weights = F.softmax(valid_similarities / temperature, dim=0)

# ç»“åˆé˜ˆå€¼æƒé‡
combined_weights = weights * valid_weights_smooth

# å¯å­¦ä¹ ç¼©æ”¾
adjusted_weights = combined_weights * (1.0 + scale * valid_similarities)
adjusted_weights = adjusted_weights / adjusted_weights.sum()

# åŠ æƒå¹³å‡
weighted_similar_repr = torch.sum(valid_reprs * adjusted_weights.unsqueeze(1), dim=0)
```

### åº”ç”¨å¢å¼º

```python
# çº¿æ€§æ’å€¼
enhanced = (1.0 - strength) * original + strength * weighted_similar
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¢å¼ºå¼ºåº¦**: å»ºè®®ä¿æŒå¢å¼ºå¼ºåº¦åœ¨0.05-0.1ä¹‹é—´ï¼Œé¿å…è¿‡åº¦å½±å“åŸæ¨¡å‹
2. **é˜ˆå€¼è®¾ç½®**: åˆå§‹é˜ˆå€¼0.5æ˜¯ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œå¯ä»¥æ ¹æ®æ•°æ®é›†è°ƒæ•´
3. **è®­ç»ƒç¨³å®šæ€§**: å¯å­¦ä¹ å‚æ•°ä¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨ä¼˜åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´
4. **å†…å­˜å¼€é”€**: æ¯ä¸ªbatchéœ€è¦è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µï¼Œå†…å­˜å¼€é”€çº¦ä¸º `O(batch_size * num_relations^2)`

## ğŸ“ æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
- `test_similarity_enhancer.py`: æµ‹è¯•è„šæœ¬
- `SIMILARITY_ENHANCEMENT_README.md`: è¯¦ç»†è¯´æ˜æ–‡æ¡£
- `SIMILARITY_ENHANCEMENT_SUMMARY.md`: æœ¬æ€»ç»“æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- `ultra/enhanced_models.py`: 
  - æ–°å¢ `SimilarityBasedRelationEnhancer` ç±»
  - ä¿®æ”¹ `EnhancedUltra` ç±»ï¼Œé›†æˆç›¸ä¼¼åº¦å¢å¼ºæ¨¡å—

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å®é™…æµ‹è¯•**: åœ¨çœŸå®æ•°æ®é›†ä¸Šè®­ç»ƒå’Œè¯„ä¼°ï¼ŒéªŒè¯æ€§èƒ½æå‡
2. **å‚æ•°è°ƒä¼˜**: æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´åˆå§‹å‚æ•°
3. **æ€§èƒ½åˆ†æ**: åˆ†æå“ªäº›ç±»å‹çš„æŸ¥è¯¢å—ç›Šæœ€å¤š
4. **è¿›ä¸€æ­¥ä¼˜åŒ–**: å¦‚æœæ•ˆæœè‰¯å¥½ï¼Œå¯ä»¥è€ƒè™‘æ›´å¤æ‚çš„èåˆç­–ç•¥

---

**å®ç°å®Œæˆæ—¥æœŸ**: 2025-01-31  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**å¯ç”¨æ€§**: âœ… å¯ç›´æ¥ä½¿ç”¨



