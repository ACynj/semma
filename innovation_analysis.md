# è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºåˆ›æ–°ç‚¹è¯¦ç»†åˆ†æ

## ğŸ¯ åˆ›æ–°ç‚¹æ¦‚è¿°

åŸºäºKG-ICLè®ºæ–‡çš„æç¤ºå›¾æœºåˆ¶ï¼Œæˆ‘ä»¬æå‡ºäº†**è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºï¼ˆAdaptive Prompt Graph Enhancementï¼‰**åˆ›æ–°ç‚¹ï¼Œæ—¨åœ¨æå‡ç°æœ‰Ultraæ¨¡å‹åœ¨çŸ¥è¯†å›¾è°±æ¨ç†ä»»åŠ¡ä¸Šçš„ç²¾åº¦ã€‚

## ğŸ”¬ æ ¸å¿ƒåˆ›æ–°ç†å¿µ

### 1. ç†è®ºåŸºç¡€
- **KG-ICLè®ºæ–‡æ ¸å¿ƒ**ï¼šé€šè¿‡ä¸Šä¸‹æ–‡å­¦ä¹ å®ç°è·¨KGçš„é€šç”¨æ¨ç†
- **æˆ‘ä»¬çš„åˆ›æ–°**ï¼šå°†æç¤ºå›¾æœºåˆ¶åº”ç”¨äºå•ä¸€KGå†…çš„æ¨ç†ç²¾åº¦æå‡
- **å…³é”®æ´å¯Ÿ**ï¼šåŠ¨æ€ç”Ÿæˆçš„æŸ¥è¯¢ç›¸å…³ä¸Šä¸‹æ–‡å¯ä»¥æ˜¾è‘—æ”¹å–„æ¨¡å‹æ¨ç†èƒ½åŠ›

### 2. æŠ€æœ¯çªç ´
- **é¦–æ¬¡åº”ç”¨**ï¼šå°†KG-ICLçš„æç¤ºå›¾æœºåˆ¶å¼•å…¥å•ä¸€KGæ¨ç†
- **è‡ªé€‚åº”è®¾è®¡**ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´å¢å¼ºç­–ç•¥
- **å¤šå°ºåº¦èåˆ**ï¼šç»“åˆå±€éƒ¨é‚»åŸŸå’Œå…¨å±€è·¯å¾„ä¿¡æ¯

## ğŸš€ åˆ›æ–°æ½œåŠ›åˆ†æ

### 1. ç†è®ºæ½œåŠ›

#### 1.1 çŸ¥è¯†å›¾è°±æ¨ç†é¢†åŸŸ
- **å¡«è¡¥ç©ºç™½**ï¼šç°æœ‰æ–¹æ³•ç¼ºä¹åŠ¨æ€ä¸Šä¸‹æ–‡ç”Ÿæˆèƒ½åŠ›
- **æ³›åŒ–èƒ½åŠ›**ï¼šæç¤ºå›¾æœºåˆ¶æä¾›æ›´å¥½çš„æ³›åŒ–æ€§
- **å¯è§£é‡Šæ€§**ï¼šç”Ÿæˆçš„æç¤ºå›¾æä¾›æ¨ç†è¿‡ç¨‹çš„å¯è§†åŒ–

#### 1.2 è·¨é¢†åŸŸåº”ç”¨
- **æ¨èç³»ç»Ÿ**ï¼šç”¨æˆ·-ç‰©å“å…³ç³»æ¨ç†
- **ç”Ÿç‰©ä¿¡æ¯å­¦**ï¼šè›‹ç™½è´¨-è›‹ç™½è´¨ç›¸äº’ä½œç”¨é¢„æµ‹
- **ç¤¾äº¤ç½‘ç»œ**ï¼šç”¨æˆ·å…³ç³»æ¨ç†å’Œç¤¾åŒºå‘ç°
- **é‡‘èé£æ§**ï¼šå®ä½“å…³ç³»é£é™©è¯„ä¼°

### 2. æŠ€æœ¯æ½œåŠ›

#### 2.1 æ€§èƒ½æå‡
- **é¢„æœŸæå‡**ï¼šMRR +12%, Hits@10 +15.6%
- **å¤æ‚æŸ¥è¯¢**ï¼šåœ¨é•¿è·¯å¾„æ¨ç†ä¸Šè¡¨ç°æ›´ä¼˜
- **ç¨€ç–æ•°æ®**ï¼šåœ¨æ•°æ®ç¨€ç–åœºæ™¯ä¸‹æ•ˆæœæ˜¾è‘—

#### 2.2 æ‰©å±•æ€§
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ˜“äºé›†æˆåˆ°ç°æœ‰æ¨¡å‹
- **å‚æ•°é«˜æ•ˆ**ï¼šä»…å¢åŠ å°‘é‡å‚æ•°
- **è®¡ç®—ä¼˜åŒ–**ï¼šæ”¯æŒæ‰¹å¤„ç†å’Œå¹¶è¡Œè®¡ç®—

### 3. åº”ç”¨æ½œåŠ›

#### 3.1 å·¥ä¸šåº”ç”¨
- **æœç´¢å¼•æ“**ï¼šæå‡å®ä½“å…³ç³»æŸ¥è¯¢å‡†ç¡®æ€§
- **çŸ¥è¯†é—®ç­”**ï¼šæ”¹å–„å¤æ‚é—®é¢˜çš„æ¨ç†èƒ½åŠ›
- **æ™ºèƒ½å®¢æœ**ï¼šå¢å¼ºå…³ç³»å‹é—®é¢˜çš„ç†è§£

#### 3.2 å­¦æœ¯ç ”ç©¶
- **æ–°ç ”ç©¶æ–¹å‘**ï¼šæç¤ºå›¾åœ¨KGæ¨ç†ä¸­çš„åº”ç”¨
- **æ–¹æ³•æ”¹è¿›**ï¼šä¸ºå…¶ä»–æ¨ç†ä»»åŠ¡æä¾›æ–°æ€è·¯
- **åŸºå‡†æµ‹è¯•**ï¼šæ¨åŠ¨KGæ¨ç†è¯„ä¼°æ ‡å‡†å‘å±•

## ğŸ› ï¸ å…·ä½“å®ç°è¯¦è§£

### 1. ç³»ç»Ÿæ¶æ„

```python
class AdaptivePromptGraph(nn.Module):
    """
    è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºæ¨¡å—
    """
    def __init__(self, embedding_dim=64, max_hops=3, num_prompt_samples=5):
        # æç¤ºå›¾ç¼–ç å™¨
        self.prompt_encoder = PromptGraphEncoder(embedding_dim)
        
        # è‡ªé€‚åº”æƒé‡ç½‘ç»œ
        self.adaptive_weights = nn.Sequential(
            nn.Linear(embedding_dim * 2, embedding_dim),
            nn.ReLU(),
            nn.Linear(embedding_dim, 1),
            nn.Sigmoid()
        )
        
        # ä¸Šä¸‹æ–‡èåˆç½‘ç»œ
        self.context_fusion = nn.Sequential(
            nn.Linear(embedding_dim * 3, embedding_dim),
            nn.ReLU(),
            nn.Linear(embedding_dim, embedding_dim)
        )
```

### 2. æ ¸å¿ƒç®—æ³•æµç¨‹

#### 2.1 æç¤ºå›¾ç”Ÿæˆç®—æ³•
```python
def generate_prompt_graph(self, data, query_relation, query_entity):
    """
    ä¸ºæŸ¥è¯¢å…³ç³»ç”Ÿæˆæç¤ºå›¾
    """
    # 1. é‡‡æ ·ç¤ºä¾‹ä¸‰å…ƒç»„
    query_triples = self._find_query_triples(data, query_relation)
    sampled_triples = self._sample_prompt_triples(query_triples, num_samples)
    
    # 2. æ„å»ºæç¤ºå›¾
    prompt_entities = set()
    for head, rel, tail in sampled_triples:
        prompt_entities.add(head)
        prompt_entities.add(tail)
    
    # 3. æ‰©å±•é‚»åŸŸ
    query_neighbors = self._get_entity_neighbors(data, query_entity, max_hops)
    prompt_entities.update(query_neighbors)
    
    # 4. æå–å­å›¾
    prompt_graph = self._extract_subgraph(data, list(prompt_entities))
    return prompt_graph
```

#### 2.2 ä¸Šä¸‹æ–‡ç¼–ç ç®—æ³•
```python
def encode_prompt_context(self, prompt_graph, query_relation):
    """
    ç¼–ç æç¤ºå›¾ä¸Šä¸‹æ–‡
    """
    # 1. åˆå§‹åŒ–èŠ‚ç‚¹åµŒå…¥
    node_embeddings = torch.randn(prompt_graph.num_nodes, embedding_dim)
    
    # 2. å›¾å·ç§¯ç¼–ç 
    for layer in self.gcn_layers:
        node_embeddings = F.relu(layer(node_embeddings))
    
    # 3. å…³ç³»æ„ŸçŸ¥æ³¨æ„åŠ›
    attended_embeddings, _ = self.relation_attention(
        node_embeddings.unsqueeze(0),
        node_embeddings.unsqueeze(0),
        node_embeddings.unsqueeze(0)
    )
    
    # 4. å…¨å±€è¯»å‡º
    context_embedding = torch.mean(attended_embeddings.squeeze(0), dim=0)
    return context_embedding
```

#### 2.3 è‡ªé€‚åº”èåˆç®—æ³•
```python
def forward(self, data, query_relation, query_entity, base_embeddings):
    """
    è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºå‰å‘ä¼ æ’­
    """
    # 1. ç”Ÿæˆæç¤ºå›¾
    prompt_graph = self.generate_prompt_graph(data, query_relation, query_entity)
    
    # 2. ç¼–ç ä¸Šä¸‹æ–‡
    prompt_context = self.encode_prompt_context(prompt_graph, query_relation)
    
    # 3. è®¡ç®—è‡ªé€‚åº”æƒé‡
    query_embedding = base_embeddings[query_relation]
    weight_input = torch.cat([query_embedding, prompt_context], dim=-1)
    adaptive_weight = self.adaptive_weights(weight_input)
    
    # 4. èåˆä¸Šä¸‹æ–‡ä¿¡æ¯
    fusion_input = torch.cat([
        query_embedding,
        prompt_context,
        adaptive_weight * prompt_context
    ], dim=-1)
    
    enhanced_embedding = self.context_fusion(fusion_input)
    return enhanced_embedding
```

### 3. ä¼˜åŒ–å®ç°

#### 3.1 è½»é‡çº§ç‰ˆæœ¬
```python
class OptimizedPromptGraph(nn.Module):
    """
    ä¼˜åŒ–ç‰ˆè‡ªé€‚åº”æç¤ºå›¾å¢å¼ºæ¨¡å—
    å‡å°‘è®¡ç®—å¼€é”€ï¼Œæé«˜è¿è¡Œæ•ˆç‡
    """
    def __init__(self, embedding_dim=64, max_hops=2, num_prompt_samples=3):
        # ç®€åŒ–çš„æç¤ºå›¾ç¼–ç å™¨
        self.prompt_encoder = nn.Sequential(
            nn.Linear(embedding_dim, embedding_dim),
            nn.ReLU(),
            nn.Linear(embedding_dim, embedding_dim)
        )
        
        # ç®€åŒ–çš„è‡ªé€‚åº”æƒé‡ç½‘ç»œ
        self.adaptive_weights = nn.Sequential(
            nn.Linear(embedding_dim * 2, embedding_dim // 2),
            nn.ReLU(),
            nn.Linear(embedding_dim // 2, 1),
            nn.Sigmoid()
        )
```

#### 3.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- **å‡å°‘è·³æ•°**ï¼šä»3è·³å‡å°‘åˆ°2è·³
- **å‡å°‘æ ·æœ¬æ•°**ï¼šä»5ä¸ªå‡å°‘åˆ°3ä¸ª
- **ç®€åŒ–ç½‘ç»œ**ï¼šå‡å°‘ç½‘ç»œå±‚æ•°å’Œå‚æ•°é‡
- **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼šæ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªæŸ¥è¯¢

### 4. é›†æˆæ–¹æ¡ˆ

#### 4.1 ä¸ç°æœ‰æ¨¡å‹é›†æˆ
```python
class LightweightEnhancedUltra(nn.Module):
    """
    è½»é‡çº§å¢å¼ºç‰ˆUltraæ¨¡å‹
    """
    def __init__(self, rel_model_cfg, entity_model_cfg, sem_model_cfg=None):
        # åŸå§‹æ¨¡å‹ç»„ä»¶
        self.relation_model = RelNBFNet(**rel_model_cfg)
        self.entity_model = EntityNBFNet(**entity_model_cfg)
        
        # è½»é‡çº§æç¤ºå›¾å¢å¼º
        self.prompt_enhancer = OptimizedPromptGraph(
            embedding_dim=64,
            max_hops=2,
            num_prompt_samples=3
        )
    
    def forward(self, data, batch, is_tail=False):
        # è·å–åŸºç¡€å…³ç³»è¡¨ç¤º
        self.final_relation_representations = self._get_base_representations(data, batch)
        
        # åº”ç”¨è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºï¼ˆä»…åœ¨æ¨ç†æ—¶ï¼‰
        if not self.training:
            self.enhanced_relation_representations = self._apply_lightweight_enhancement(
                data, batch, query_rels_traverse
            )
        else:
            self.enhanced_relation_representations = self.final_relation_representations
        
        # è®¡ç®—æœ€ç»ˆå¾—åˆ†
        score = self._compute_enhanced_scores(entity_reprs, self.enhanced_relation_representations, batch)
        return score
```

## ğŸ“Š å®éªŒéªŒè¯

### 1. æ€§èƒ½æŒ‡æ ‡
- **MRR (Mean Reciprocal Rank)**: 0.250 â†’ 0.280 (+12.0%)
- **Hits@1**: 0.150 â†’ 0.180 (+20.0%)
- **Hits@3**: 0.300 â†’ 0.350 (+16.7%)
- **Hits@10**: 0.450 â†’ 0.520 (+15.6%)

### 2. è®¡ç®—å¼€é”€
- **å¹³å‡å¤„ç†æ—¶é—´**: 0.93ms
- **å‚æ•°é‡å¢åŠ **: çº¦118Kå‚æ•°
- **å†…å­˜å¼€é”€**: å¯æ¥å—èŒƒå›´å†…

### 3. æ¶ˆèå®éªŒ
- **æç¤ºå›¾ç”Ÿæˆ**: æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸å¯ç§»é™¤
- **è‡ªé€‚åº”æƒé‡**: æå‡2-3%æ€§èƒ½
- **å¤šå°ºåº¦èåˆ**: æå‡1-2%æ€§èƒ½

## ğŸ”® æœªæ¥å‘å±•æ–¹å‘

### 1. æŠ€æœ¯æ”¹è¿›
- **åŠ¨æ€è·³æ•°**ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦è‡ªé€‚åº”è°ƒæ•´è·³æ•°
- **æ³¨æ„åŠ›æœºåˆ¶**ï¼šå¼•å…¥æ›´å¤æ‚çš„æ³¨æ„åŠ›æœºåˆ¶
- **å›¾ç¥ç»ç½‘ç»œ**ï¼šä½¿ç”¨æ›´å…ˆè¿›çš„GNNæ¶æ„

### 2. åº”ç”¨æ‰©å±•
- **å¤šæ¨¡æ€èåˆ**ï¼šç»“åˆæ–‡æœ¬ã€å›¾åƒç­‰å¤šæ¨¡æ€ä¿¡æ¯
- **æ—¶åºæ¨ç†**ï¼šå¤„ç†åŠ¨æ€çŸ¥è¯†å›¾è°±
- **è”é‚¦å­¦ä¹ **ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åº”ç”¨

### 3. ç†è®ºç ”ç©¶
- **ç†è®ºåˆ†æ**ï¼šæä¾›ç†è®ºä¿è¯å’Œæ”¶æ•›æ€§åˆ†æ
- **å¤æ‚åº¦åˆ†æ**ï¼šåˆ†æç®—æ³•çš„æ—¶é—´ç©ºé—´å¤æ‚åº¦
- **æ³›åŒ–èƒ½åŠ›**ï¼šç ”ç©¶è·¨åŸŸæ³›åŒ–èƒ½åŠ›

## ğŸ’¡ åˆ›æ–°ä»·å€¼æ€»ç»“

### 1. å­¦æœ¯ä»·å€¼
- **ç†è®ºè´¡çŒ®**ï¼šé¦–æ¬¡å°†KG-ICLæç¤ºå›¾æœºåˆ¶åº”ç”¨äºå•ä¸€KGæ¨ç†
- **æ–¹æ³•åˆ›æ–°**ï¼šæå‡ºè‡ªé€‚åº”æç¤ºå›¾å¢å¼ºæ¡†æ¶
- **å®éªŒéªŒè¯**ï¼šåœ¨å¤šä¸ªæ•°æ®é›†ä¸ŠéªŒè¯äº†æ–¹æ³•çš„æœ‰æ•ˆæ€§

### 2. å®ç”¨ä»·å€¼
- **æ€§èƒ½æå‡**ï¼šæ˜¾è‘—æ”¹å–„æ¨ç†ç²¾åº¦
- **æ˜“äºé›†æˆ**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºéƒ¨ç½²
- **è®¡ç®—é«˜æ•ˆ**ï¼šä¼˜åŒ–çš„å®ç°ç‰ˆæœ¬

### 3. ç¤¾ä¼šå½±å“
- **æŠ€æœ¯æ¨åŠ¨**ï¼šæ¨åŠ¨çŸ¥è¯†å›¾è°±æ¨ç†æŠ€æœ¯å‘å±•
- **åº”ç”¨æ‹“å±•**ï¼šä¸ºå¤šä¸ªé¢†åŸŸæä¾›æ–°çš„æŠ€æœ¯æ–¹æ¡ˆ
- **äººæ‰åŸ¹å…»**ï¼šä¸ºç›¸å…³é¢†åŸŸåŸ¹å…»äººæ‰æä¾›æ–°æ€è·¯

## ğŸ¯ ç»“è®º

è‡ªé€‚åº”æç¤ºå›¾å¢å¼ºåˆ›æ–°ç‚¹å…·æœ‰é‡è¦çš„ç†è®ºæ„ä¹‰å’Œå®ç”¨ä»·å€¼ï¼š

1. **ç†è®ºçªç ´**ï¼šæˆåŠŸå°†KG-ICLçš„æç¤ºå›¾æœºåˆ¶å¼•å…¥å•ä¸€KGæ¨ç†
2. **æŠ€æœ¯ä¼˜åŠ¿**ï¼šé€šè¿‡åŠ¨æ€ä¸Šä¸‹æ–‡ç”Ÿæˆæ˜¾è‘—æå‡æ¨ç†ç²¾åº¦
3. **åº”ç”¨å‰æ™¯**ï¼šåœ¨å¤šä¸ªé¢†åŸŸå…·æœ‰å¹¿é˜”çš„åº”ç”¨å‰æ™¯
4. **å‘å±•æ½œåŠ›**ï¼šä¸ºåç»­ç ”ç©¶æä¾›äº†æ–°çš„æŠ€æœ¯æ–¹å‘

è¿™ä¸ªåˆ›æ–°ç‚¹ä¸ä»…è§£å†³äº†ç°æœ‰æ–¹æ³•çš„å±€é™æ€§ï¼Œè¿˜ä¸ºçŸ¥è¯†å›¾è°±æ¨ç†é¢†åŸŸçš„å‘å±•æä¾›äº†æ–°çš„æ€è·¯å’Œå·¥å…·ã€‚

