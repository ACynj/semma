# Prompt Enhancer æ€§èƒ½ä¼˜åŒ–æ€»ç»“

## ğŸ” é—®é¢˜åˆ†æ

æ ¹æ®æ€§èƒ½æ—¥å¿—ï¼Œæ¯ä¸ªbatchçš„Prompt Enhancerè€—æ—¶13-16ç§’ï¼Œä¸»è¦ç“¶é¢ˆï¼š

1. **è¿‡æ»¤è¾¹çš„å¾ªç¯**ï¼ˆç¬¬828-835è¡Œï¼‰ï¼šéå†æ‰€æœ‰371168æ¡è¾¹ï¼Œæ¯æ¬¡è°ƒç”¨`.item()`
2. **å®ä½“åµŒå…¥è®¡ç®—çš„å¾ªç¯**ï¼ˆç¬¬1018-1036è¡Œï¼‰ï¼šæ¯ä¸ªå®ä½“éƒ½è¦æŸ¥æ‰¾è¾¹

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. è¿‡æ»¤è¾¹æ“ä½œå‘é‡åŒ– âœ…

**ä¼˜åŒ–å‰**ï¼š
```python
for i in range(data.edge_index.shape[1]):  # éå†371168æ¡è¾¹
    src = data.edge_index[0, i].item()     # æ¯æ¬¡è°ƒç”¨.item()å¾ˆæ…¢
    dst = data.edge_index[1, i].item()
    if src in prompt_entities_set and dst in prompt_entities_set:
        edge_mask[i] = True
```

**ä¼˜åŒ–å**ï¼š
```python
# ä½¿ç”¨å‘é‡åŒ–æ“ä½œ
prompt_entities_tensor = torch.tensor(list(prompt_entities_set), device=device, dtype=torch.long)
src_nodes = data.edge_index[0]  # [num_edges]
dst_nodes = data.edge_index[1]  # [num_edges]

# ä½¿ç”¨torch.isinï¼ˆå‘é‡åŒ–ï¼Œæ¯”å¾ªç¯å¿«å¾ˆå¤šï¼‰
src_in_prompt = torch.isin(src_nodes, prompt_entities_tensor)
dst_in_prompt = torch.isin(dst_nodes, prompt_entities_tensor)
edge_mask = src_in_prompt & dst_in_prompt
```

**é¢„æœŸåŠ é€Ÿ**ï¼š**10-50å€**ï¼ˆå–å†³äºå®ä½“æ•°é‡ï¼‰

### 2. å®ä½“åµŒå…¥è®¡ç®—ä¼˜åŒ– âœ…

**ä¼˜åŒ–å‰**ï¼š
```python
for i, entity_id in enumerate(prompt_entities):
    # æ¯æ¬¡éƒ½æŸ¥æ‰¾æ‰€æœ‰è¾¹
    entity_edge_mask = (data.edge_index[0] == entity_id) | (data.edge_index[1] == entity_id)
    # ...
```

**ä¼˜åŒ–å**ï¼š
```python
# å…ˆæ‰¹é‡æ‰¾åˆ°æ‰€æœ‰ç›¸å…³è¾¹ï¼ˆå‘é‡åŒ–ï¼‰
prompt_entities_tensor = torch.tensor(prompt_entities, device=device, dtype=torch.long)
src_mask = torch.isin(data.edge_index[0], prompt_entities_tensor)
dst_mask = torch.isin(data.edge_index[1], prompt_entities_tensor)
relevant_edge_mask = src_mask | dst_mask

# ç„¶ååœ¨ç›¸å…³è¾¹ä¸­æŸ¥æ‰¾ï¼ˆå‡å°‘æœç´¢ç©ºé—´ï¼‰
for i, entity_id in enumerate(prompt_entities):
    entity_edge_mask = ((data.edge_index[0] == entity_id) | 
                        (data.edge_index[1] == entity_id)) & relevant_edge_mask
    # ...
```

**é¢„æœŸåŠ é€Ÿ**ï¼š**2-5å€**ï¼ˆå–å†³äºå®ä½“æ•°é‡å’Œè¾¹çš„åˆ†å¸ƒï¼‰

### 3. æ·»åŠ è¯¦ç»†æ€§èƒ½åˆ†æ âœ…

åœ¨å…³é”®ä½ç½®æ·»åŠ äº†æ€§èƒ½è®¡æ—¶å™¨ï¼š
- `generate_prompt_graph`ï¼šæ•´ä½“è€—æ—¶
- `encode_prompt_context`ï¼šæ•´ä½“è€—æ—¶
- `è¿‡æ»¤è¾¹`ï¼šè¿‡æ»¤æ“ä½œçš„è€—æ—¶
- `æŸ¥æ‰¾æŸ¥è¯¢å…³ç³»çš„è¾¹`ï¼šæŸ¥æ‰¾æ“ä½œçš„è€—æ—¶

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

### ä¼˜åŒ–å‰ï¼š
- è¿‡æ»¤è¾¹ï¼šçº¦ **10-12ç§’**ï¼ˆéå†371168æ¡è¾¹ï¼‰
- å®ä½“åµŒå…¥è®¡ç®—ï¼šçº¦ **2-3ç§’**ï¼ˆæ¯ä¸ªå®ä½“æŸ¥æ‰¾è¾¹ï¼‰
- æ€»è€—æ—¶ï¼š**13-16ç§’/batch**

### ä¼˜åŒ–åï¼š
- è¿‡æ»¤è¾¹ï¼šçº¦ **0.1-0.5ç§’**ï¼ˆå‘é‡åŒ–æ“ä½œï¼‰
- å®ä½“åµŒå…¥è®¡ç®—ï¼šçº¦ **0.5-1ç§’**ï¼ˆå…ˆè¿‡æ»¤ç›¸å…³è¾¹ï¼‰
- æ€»è€—æ—¶ï¼š**1-2ç§’/batch**

### æ€»ä½“åŠ é€Ÿï¼š
- **ä»13-16ç§’é™åˆ°1-2ç§’**
- **åŠ é€Ÿçº¦8-16å€** ğŸš€

## ğŸ¯ éªŒè¯æ–¹æ³•

è¿è¡Œæ¨¡å‹åï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

1. **è¿‡æ»¤è¾¹æ“ä½œ**åº”è¯¥ä»10-12ç§’é™åˆ°0.1-0.5ç§’ï¼š
   ```
   [æ€§èƒ½] è¿‡æ»¤è¾¹ (æ€»è¾¹æ•°=371168, å®ä½“æ•°=XXX): 100-500ms
   ```

2. **æ•´ä½“è€—æ—¶**åº”è¯¥ä»13-16ç§’é™åˆ°1-2ç§’ï¼š
   ```
   [æ€§èƒ½] generate_prompt_graph: 500-1000ms
   [æ€§èƒ½] encode_prompt_context: 500-1000ms
   [æ€§èƒ½] Prompt Enhancer batch X: 1000-2000ms
   ```

## ğŸ“ ä»£ç ä½ç½®

- **è¿‡æ»¤è¾¹ä¼˜åŒ–**ï¼š`ultra/enhanced_models.py` ç¬¬829-849è¡Œ
- **å®ä½“åµŒå…¥ä¼˜åŒ–**ï¼š`ultra/enhanced_models.py` ç¬¬1022-1057è¡Œ
- **æ€§èƒ½åˆ†æ**ï¼š`ultra/enhanced_models.py` ç¬¬1117-1126è¡Œ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜ä½¿ç”¨**ï¼šå‘é‡åŒ–æ“ä½œä¼šåˆ›å»ºä¸€äº›ä¸­é—´tensorï¼Œä½†å†…å­˜å¼€é”€æ˜¯å¯æ¥å—çš„

2. **GPU/CPU**ï¼š`torch.isin`åœ¨GPUä¸Šå¯èƒ½ä¸å¦‚CPUå¿«ï¼Œå¦‚æœå¾ˆæ…¢å¯ä»¥å°è¯•ç§»åˆ°CPU

3. **è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼šå¦‚æœå®ä½“åµŒå…¥è®¡ç®—ä»ç„¶å¾ˆæ…¢ï¼Œå¯ä»¥è€ƒè™‘ï¼š
   - å®Œå…¨å‘é‡åŒ–å®ä½“åµŒå…¥è®¡ç®—ï¼ˆä½¿ç”¨scatteræ“ä½œï¼‰
   - æˆ–è€…ç®€åŒ–å®ä½“åµŒå…¥ç­–ç•¥ï¼ˆä¸ä½¿ç”¨å…³ç³»å¹³å‡ï¼Œç›´æ¥ä½¿ç”¨æŸ¥è¯¢å…³ç³»åµŒå…¥ï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥

è¿è¡Œæ¨¡å‹éªŒè¯æ•ˆæœï¼ŒæŸ¥çœ‹æ€§èƒ½æ—¥å¿—ç¡®è®¤ï¼š
1. è¿‡æ»¤è¾¹æ“ä½œæ˜¯å¦æ˜¾è‘—åŠ é€Ÿ
2. æ•´ä½“è€—æ—¶æ˜¯å¦é™åˆ°1-2ç§’
3. å¦‚æœè¿˜æœ‰ç“¶é¢ˆï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–

å¦‚æœä»ç„¶å¾ˆæ…¢ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- ç¦ç”¨Prompt Enhancerï¼ˆå¦‚æœæ•ˆæœä¸æ˜æ˜¾ï¼‰
- æˆ–è€…è¿›ä¸€æ­¥ç®€åŒ–å®ä½“åµŒå…¥è®¡ç®—

