# éªŒè¯EnhancedUltraå¢å¼ºåŠŸèƒ½å¯ç”¨çŠ¶æ€

## âœ… ä»£ç éªŒè¯ç»“æœ

é€šè¿‡æ£€æŸ¥ä»£ç  `ultra/enhanced_models.py` ç¬¬333-338è¡Œï¼š

```python
# åŸºäºç›¸ä¼¼åº¦çš„å…³ç³»å¢å¼ºç­–ç•¥
# åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½ä½¿ç”¨ï¼Œä½†å¼ºåº¦è¾ƒå°ï¼Œä¸ä¼šè¿‡åº¦å½±å“åŸæ¨¡å‹
self.enhanced_relation_representations = self.similarity_enhancer(
    self.final_relation_representations, 
    query_rels
)
```

**å…³é”®å‘ç°**:
- âœ… **æ²¡æœ‰ `if not self.training:` åˆ¤æ–­**
- âœ… **æ²¡æœ‰ `if self.training:` åˆ¤æ–­**
- âœ… **æ³¨é‡Šæ˜ç¡®è¯´æ˜ï¼šåœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½ä½¿ç”¨**

## ğŸ“‹ éªŒè¯æ–¹æ³•

### æ–¹æ³•1: ä»£ç æ£€æŸ¥ï¼ˆæœ€å¯é ï¼‰

ç›´æ¥æ£€æŸ¥ `ultra/enhanced_models.py`:

```bash
grep -A 5 "similarity_enhancer" ultra/enhanced_models.py
```

å¦‚æœçœ‹åˆ°ï¼š
- âœ… `self.similarity_enhancer(...)` ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰æ¡ä»¶
- âœ… æ³¨é‡Šè¯´"åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½ä½¿ç”¨"

é‚£å°±æ˜¯**è®­ç»ƒå’Œæ¨ç†éƒ½å¯ç”¨**ã€‚

### æ–¹æ³•2: å®é™…è¿è¡ŒéªŒè¯

#### éªŒè¯æ¨ç†æ—¶å¯ç”¨ï¼š

```bash
# 1. è®¾ç½®flags.yaml
echo "run: EnhancedUltra" > flags.yaml  # ä¸´æ—¶ä¿®æ”¹

# 2. è¿è¡Œæ¨ç†ï¼ˆä¼šè‡ªåŠ¨è®¾ç½®ä¸ºevalæ¨¡å¼ï¼‰
conda activate semma
python script/run.py \
    -c config/transductive/inference.yaml \
    --dataset FB15k237 \
    --epochs 0 --bpe null \
    --ckpt ckpts/semma.pth \
    --gpus [0]
```

åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹ï¼š
- æ˜¯å¦æœ‰"éƒ¨åˆ†åŠ è½½å®Œæˆ"çš„æç¤ºï¼ˆè¯´æ˜EnhancedUltraè¢«åŠ è½½ï¼‰
- å¦‚æœæœ‰ç›¸ä¼¼å…³ç³»ï¼Œå¢å¼ºä¼šç”Ÿæ•ˆ

#### éªŒè¯è®­ç»ƒæ—¶å¯ç”¨ï¼š

```bash
# 1. è®¾ç½®flags.yaml
sed -i 's/run:.*/run: EnhancedUltra/' flags.yaml

# 2. è¿è¡Œè®­ç»ƒï¼ˆä¼šè‡ªåŠ¨è®¾ç½®ä¸ºtrainæ¨¡å¼ï¼‰
conda activate semma
python script/pretrain.py \
    -c config/transductive/pretrain_3g.yaml \
    --gpus [0]
```

åœ¨è®­ç»ƒæ—¥å¿—ä¸­ï¼š
- è§‚å¯ŸæŸå¤±å€¼ï¼ˆå¦‚æœæœ‰å¢å¼ºï¼Œå¯èƒ½æœ‰å°å¹…æ³¢åŠ¨ï¼‰
- æ£€æŸ¥checkpointä¸­æ˜¯å¦åŒ…å« `similarity_enhancer` çš„å‚æ•°

### æ–¹æ³•3: æ£€æŸ¥checkpointå‚æ•°

ä¿å­˜çš„checkpointåº”è¯¥åŒ…å«ï¼š

```python
import torch

checkpoint = torch.load('ckpts/enhanced_model.pth', map_location='cpu')
model_dict = checkpoint['model']

# æ£€æŸ¥æ˜¯å¦åŒ…å«å¢å¼ºå‚æ•°
enhancement_params = [k for k in model_dict.keys() if 'similarity_enhancer' in k]

print(f"å¢å¼ºå‚æ•°æ•°é‡: {len(enhancement_params)}")
for param in enhancement_params[:5]:
    print(f"  - {param}")
```

å¦‚æœæœ‰è¿™äº›å‚æ•°ï¼Œè¯´æ˜è®­ç»ƒæ—¶å¯ç”¨äº†å¢å¼ºã€‚

## ğŸ¯ ç»“è®º

### âœ… è®­ç»ƒå’Œæ¨ç†éƒ½å¯ç”¨å¢å¼º

**è¯æ®**:
1. ä»£ç ä¸­**æ²¡æœ‰** `if self.training:` æˆ– `if not self.training:` åˆ¤æ–­
2. æ³¨é‡Šæ˜ç¡®è¯´æ˜"åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶éƒ½ä½¿ç”¨"
3. `similarity_enhancer` åœ¨forwardä¸­**æ— æ¡ä»¶è°ƒç”¨**

### ğŸ“Š å®é™…ä½¿ç”¨å»ºè®®

#### åœºæ™¯1: ä»SEMMA checkpointç»§ç»­è®­ç»ƒï¼ˆæ¨èï¼‰

```bash
# æ­¥éª¤
1. ä¿®æ”¹flags.yaml: run: EnhancedUltra
2. ä½¿ç”¨SEMMA checkpointç»§ç»­è®­ç»ƒï¼ˆéƒ¨åˆ†åŠ è½½ï¼‰
3. è®­ç»ƒ3-5ä¸ªepochè®©å¢å¼ºå‚æ•°å­¦ä¹ 
4. è¯„ä¼°æ€§èƒ½
```

**ä¼˜ç‚¹**: åˆ©ç”¨å·²æœ‰SEMMAæƒé‡ï¼Œåªå­¦ä¹ å¢å¼ºå‚æ•°

#### åœºæ™¯2: ä»å¤´è®­ç»ƒEnhancedUltra

```bash
# æ­¥éª¤
1. ä¿®æ”¹flags.yaml: run: EnhancedUltra  
2. ä»å¤´è®­ç»ƒï¼ˆæ‰€æœ‰å‚æ•°ä¸€èµ·å­¦ä¹ ï¼‰
3. è¯„ä¼°æ€§èƒ½
```

**ä¼˜ç‚¹**: æ‰€æœ‰å‚æ•°ååŒä¼˜åŒ–

#### åœºæ™¯3: å¿«é€Ÿæµ‹è¯•ï¼ˆä¸æ¨èç”¨äºæ€§èƒ½è¯„ä¼°ï¼‰

```bash
# æ­¥éª¤
1. ä¿®æ”¹flags.yaml: run: EnhancedUltra
2. ç›´æ¥ç”¨SEMMA checkpointæ¨ç†æµ‹è¯•
```

**æ³¨æ„**: å¢å¼ºå‚æ•°éšæœºåˆå§‹åŒ–ï¼Œæ•ˆæœå¯èƒ½ä¸æ˜æ˜¾

## âš ï¸ é‡è¦æç¤º

1. **Checkpointå…¼å®¹æ€§**: 
   - ä»SEMMA checkpointåŠ è½½åˆ°EnhancedUltraï¼šâœ… æ”¯æŒï¼ˆéƒ¨åˆ†åŠ è½½ï¼‰
   - ä»EnhancedUltra checkpointåŠ è½½åˆ°EnhancedUltraï¼šâœ… æ”¯æŒï¼ˆå®Œå…¨åŠ è½½ï¼‰
   - ä»EnhancedUltra checkpointåŠ è½½åˆ°SEMMAï¼šâš ï¸ ä¼šæœ‰é¢å¤–å‚æ•°è¢«å¿½ç•¥

2. **å‚æ•°åˆå§‹åŒ–**:
   - ä»SEMMAåŠ è½½æ—¶ï¼Œ`similarity_enhancer`å‚æ•°ä¼šéšæœºåˆå§‹åŒ–
   - å»ºè®®ç»§ç»­è®­ç»ƒå‡ ä¸ªepochè®©å‚æ•°å­¦ä¹ 

3. **è®­ç»ƒç›‘æ§**:
   - å»ºè®®åœ¨éªŒè¯é›†ä¸Šç›‘æ§ï¼Œç¡®è®¤å¢å¼ºæœ‰å¸®åŠ©
   - å¦‚æœæ€§èƒ½ä¸‹é™ï¼Œå¯ä»¥å‡å°å¢å¼ºå¼ºåº¦åˆå§‹å€¼

## ğŸ“ æ€»ç»“

**è®­ç»ƒå’Œæ¨ç†éƒ½å¯ç”¨å¢å¼º** âœ…

- ä»£ç å±‚é¢ï¼šæ— æ¡ä»¶è°ƒç”¨ï¼Œæ— è®­ç»ƒ/æ¨ç†åˆ¤æ–­
- ä½¿ç”¨å±‚é¢ï¼šè®­ç»ƒå’Œæ¨ç†éƒ½ä¼šä½¿ç”¨ç›¸ä¼¼åº¦å¢å¼º
- å‚æ•°å±‚é¢ï¼šå¯å­¦ä¹ å‚æ•°ä¼šåœ¨è®­ç»ƒä¸­ä¼˜åŒ–

å»ºè®®ä½¿ç”¨**æ–¹æ¡ˆ1ï¼ˆä»SEMMAç»§ç»­è®­ç»ƒï¼‰**ï¼Œè¿™æ ·å¯ä»¥ï¼š
- åˆ©ç”¨å·²æœ‰SEMMAæƒé‡
- åªå­¦ä¹ æ–°çš„å¢å¼ºå‚æ•°
- æ›´å¿«æ”¶æ•›
- é£é™©æ›´ä½



